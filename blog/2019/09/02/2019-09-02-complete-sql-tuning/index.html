<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta charset="utf-8">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>The Complete SQL Tuning</title>
  <meta name="author" content="" />

  
  <meta name="keywords" content="datafibers, big data, streaming">	
  

  
  <meta name="description" content="DataFibers enterprise open sourec data bus">	
  

  <meta name="generator" content="Hugo 0.30.2" />

  <link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  
  <link href="https://datafibers-community.github.io/css/animate.css" rel="stylesheet">

  
  
    <link href="https://datafibers-community.github.io/css/style.blue.css" rel="stylesheet" id="theme-stylesheet">
  


  
  <link href="https://datafibers-community.github.io/css/custom.css" rel="stylesheet">

  
  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
  <link rel="shortcut icon" href="https://datafibers-community.github.io/img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://datafibers-community.github.io/img/apple-touch-icon.png" />
  

  <link href="https://datafibers-community.github.io/css/owl.carousel.css" rel="stylesheet">
  <link href="https://datafibers-community.github.io/css/owl.theme.css" rel="stylesheet">

  <link rel="alternate" href="https://datafibers-community.github.io/index.xml" type="application/rss+xml" title="DataFibers">

  
  <meta property="og:title" content="The Complete SQL Tuning" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/blog/2019/09/02/2019-09-02-complete-sql-tuning//" />
  <meta property="og:image" content="img/logo.png" />

</head>


  <body>

    <div id="all">

        <header>

          <div class="navbar-affixed-top" data-spy="affix" data-offset-top="200">

    <div class="navbar navbar-default yamm" role="navigation" id="navbar">

        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="https://datafibers-community.github.io/">
                    <img src="https://datafibers-community.github.io/img/logo.png" alt="The Complete SQL Tuning logo" height="50" class="hidden-xs hidden-sm">
                    <img src="https://datafibers-community.github.io/img/logo-small.png" alt="The Complete SQL Tuning logo" class="visible-xs visible-sm">
                    <span class="sr-only">The Complete SQL Tuning - go to homepage</span>
                </a>
                <div class="navbar-buttons">
                    <button type="button" class="navbar-toggle btn-template-main" data-toggle="collapse" data-target="#navigation">
                      <span class="sr-only">Toggle Navigation</span>
                        <i class="fa fa-align-justify"></i>
                    </button>
                </div>
            </div>
            

            <div class="navbar-collapse collapse" id="navigation">
                <ul class="nav navbar-nav navbar-right">
                  
                  <li class="dropdown">
                    
                    <a href="/">Home</a>
                    
                  </li>
                  
                  <li class="dropdown">
                    
                    <a href="http://github.com/datafibers-community/df_data_service/releases/latest">Download</a>
                    
                  </li>
                  
                  <li class="dropdown">
                    
                    <a href="/community/">Community</a>
                    
                  </li>
                  
                  <li class="dropdown">
                    
                    <a href="/blog/">Blog</a>
                    
                  </li>
                  
                  <li class="dropdown">
                    
                    <a href="/training/">Training</a>
                    
                  </li>
                  
                  <li class="dropdown">
                    
                    <a href="/contact/">Contact</a>
                    
                  </li>
                  
                </ul>
            </div>
            

            <div class="collapse clearfix" id="search">

                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">

                    <button type="submit" class="btn btn-template-main"><i class="fa fa-search"></i></button>

                </span>
                    </div>
                </form>

            </div>
            

        </div>
    </div>
    

</div>




        </header>

        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>The Complete SQL Tuning</h1>
            </div>
        </div>
    </div>
</div>


        <div id="content">
            <div class="container">

                <div class="row">

                    

                    <div class="col-md-9" id="blog-post">

                        <p class="text-muted text-uppercase mb-small text-right">September 2, 2019</p>

                        <div id="post-content">
                          <p>The most practice comes for MySQL server, but it applies to other relational database as well.</p>

<ol>
<li><p>Aviod full table scan and try to create index on the columns used after <strong>where</strong> or <strong>order by</strong>.</p></li>

<li><p>Aviod check null after <strong>where</strong> clause. You set set null as default value when creating tables. However, mostly we should use not null value or use special value, such as 0 or -1 for instead.</p></li>

<li><p>Avoid using != or &lt;&gt; after <strong>where</strong>. MySQL can support indexing on &lt;, &lt;=, =, &gt;, &gt;=, BETWEEN,IN, and sometimes LIKE。</p></li>

<li><p>Avoid using or after <strong>where</strong>. Or else, it causes full table scan rather using index. We can try to use <strong>UNION</strong> for instead. <code>select id from t where num=10 union all select id from t where num=20</code></p></li>

<li><p>Avoid using <strong>in</strong> and <strong>not in</strong>. Because it is likely to cause full table scan. If possible, use <strong>between</strong>, such as <code>select id from t where num between 1 and 3</code></p></li>

<li><p>Avoid using parameters after <strong>where</strong>, which is likely to cause full table scan.</p></li>

<li><p>Query <code>select id from t where name like ‘%abc%’</code> and <code>select id from t where name like ‘%abc’</code> may cause full table scan. Use <code>select id from t where name like ‘abc%’</code> to leverage index.</p></li>

<li><p>Use <strong>exists</strong> instead of <strong>in</strong>, such as <code>select num from a where num in(select num from b)</code> rewrite as <code>select num from a where exists(select 1 from b where num=a.num)</code></p></li>

<li><p>Index can improve the <strong>select</strong> performance. However, it may decrease the performance of <strong>update</strong> and <strong>insert</strong>, which could rebuild the index. Make more considerations when you create more than 6 indexes for one table.</p></li>

<li><p>Aviod update columns who has cluster index, because the cluster index use records&rsquo; physical ordering. By updating it, it leads lots of data movement physically. If ou have such kinds of columns requires frequent update, create non-cluster index on it.</p></li>

<li><p>Use number data type instead of string</p></li>

<li><p>Use <strong>varchar/nvarchar</strong> instead of <strong>char/nchar</strong> for saving more storage and improving query performance</p></li>

<li><p>If possible use columns rather than <code>select *</code></p></li>

<li><p>Use table alias when you have many tables in the query</p></li>

<li><p>Use temporary tables to deal with complex logic and data transformation.</p></li>

<li><p>Use <strong>UNION ALL</strong> has more chances to leverage index than using <strong>OR</strong>.</p></li>

<li><p>For the list of values after <strong>IN</strong>, put the most frequent value in front.</p></li>

<li><p>Since store procedure is precompiled. It has better performance.</p></li>

<li><p>Try to use <strong>exists</strong> instead of <strong>select count(1)</strong>. <strong>count(1)</strong> performs better than <strong>count(*)</strong>.</p></li>

<li><p>Using Index： Index is decided according to query patterns. Most of time, do not create too many indexes on one table (ideally, less than 6). Try to use index as munch as possible. If multiple columns are used in the index, the index will be used only when the first column is used in query condition. Index rebuild should be scheduled and mainteained.　</p></li>

<li><p>Below queries have proper index created but not being used.</p>

<pre><code>SELECT * FROM record WHERE substrINg(card_no, 1, 4)= '5378' (13s) 
SELECT * FROM record WHERE amount/30 &lt; 1000 (11s)
SELECT * FROM record WHERE convert(char(10), date, 112)= '19991201' (10s)
</code></pre>

<p>By remove the calclations on the indexed columns, we ensure the index being used and performance becomes better.</p>

<pre><code>SELECT * FROM record WHERE card_no like '5378%' (&lt; 1s)
SELECT * FROM record WHERE amount &lt; 1000*30 (&lt; 1s) 
SELECT * FROM record WHERE date = '1999/12/01' (&lt; 1s)
</code></pre></li>

<li><p>Bulk insert or update is always the first choice.</p></li>

<li><p>If possible remove rows before <strong>GROUP BY</strong>.</p>

<pre><code>SELECT JOB, AVG(SAL) FROM EMP GROUP BY JOB HAVING JOB = 'PRESIDENT' OR JOB = 'MANAGER' --slower
SELECT JOB, AVG(SAL) FROM EMP WHERE JOB = 'PRESIDENT' OR JOB = 'MANAGER' GROUP BY JOB --faster
</code></pre></li>

<li><p>Try to use Common Table Expression (CTE)</p></li>

<li><p>Trigger ususally brings performance overhead.</p></li>

<li><p>Usually we add a column, such as IDas PK with INT UNSIGNED and AUTO_INCREMENT.</p></li>

<li><p>At the begining of store procedures and triggers, add <code>SET NOCOUNT ON</code>. At the end, add <code>SET NOCOUNT OFF</code>. It is not necessary to send <strong>DONE_IN_PROC</strong> message to client after executing each statement.</p></li>

<li><p>Use cache when the database supports it</p></li>

<li><p>Use <code>EXPLAIN SELECT ...</code> to check query execution plan</p></li>

<li><p>If possible, limit the returned dataset.</p></li>

<li><p>Best practice to create index</p>

<ul>
<li>PK and FK should have index created</li>
<li>Table has 300M of data should create index</li>
<li>Tables which are frequently used in join should have index on the join condition columns</li>
<li>The colunms are frequently used after <strong>where</strong> or <strong>select</strong> should have index on them</li>
<li>Index should be created on the small size columns not on bigger one, such as long text columns</li>
<li>If you have single index columns and multiple columns index on the same set of columns, remove multiple columns index</li>
<li>Multiple columns index usually contains no more than 3 columns</li>
<li>For tables which have frequently data operations, do not create too many index</li>
<li>Remove useless indexes</li>
<li>Avoid create index on the columns have many duplications or repeat values.</li>
</ul></li>

<li><p>Aviod checking null in where clause since it may cause full table scan instead of using index. Try to set default value for null when you create the table.</p></li>

<li><p>Aviod using <strong>!=, &lt;&gt;, OR</strong> in where clause since it may cause full table scan instead of using index.</p></li>

<li><p>When creating table with huge amount of data, use <code>select into</code> instead of <code>create table</code> to avoid generating too much log and improve performance.</p></li>

<li><p><code>truncate table</code>, then <code>drop table</code> to aviod locking system tables for long time.</p></li>

<li><p>Aviod using cusor because of bad performance especially when you deal with more than 10000 rows. You can use <code>while loop</code> for instead. If you have to use cusor, consider to use <strong>FAST_FORWARD</strong> cusor.</p></li>

<li><p>Aviod doing huge transactions.</p></li>

<li><p>Avoid return too much data to the client side</p></li>

<li><p>General performace tuning considerations</p>

<ul>
<li>Optimize SQL and Index <a href="http://coolshell.cn/articles/1846.html">http://coolshell.cn/articles/1846.html</a></li>
<li>Leverage cache, such as memcached or redis.</li>
<li>Master-slave/Master-master replicate. Read and write seperation</li>
<li>Use partition tables</li>
<li>Vertically split tables according to business</li>
<li>Horizontally split tables, such as using moded table name</li>
</ul></li>
</ol>

                        </div>
                        
                        
                        <div id="comments">
                            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "sparkera" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                        </div>
                        

                    </div>
                    

                    

                    

                    <div class="col-md-3">

                        

                        

<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
      <h3 class="panel-title">Search</h3>
    </div>

    <div class="panel-body">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" role="search">
            <div class="input-group">
                <input type="search" name="q" class="form-control" placeholder="Search">
                <input type="hidden" name="sitesearch" value="https://datafibers-community.github.io/">
                <span class="input-group-btn">
                    <button type="submit" class="btn btn-template-main"><i class="fa fa-search"></i></button>
                </span>
            </div>
        </form>
    </div>
</div>







<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
      <h3 class="panel-title">Categories</h3>
    </div>

    <div class="panel-body">
        <ul class="nav nav-pills nav-stacked">
            
            <li><a href="https://datafibers-community.github.io/categories/artical">artical (2)</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/categories/article">article (16)</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/categories/digest">digest (3)</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/categories/release">release (3)</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/categories/review">review (1)</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/categories/training">training (1)</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/categories/tutorial">tutorial (1)</a>
            </li>
            
        </ul>
    </div>
</div>








<div class="panel sidebar-menu">
    <div class="panel-heading">
      <h3 class="panel-title">Tags</h3>
    </div>

    <div class="panel-body">
        <ul class="tag-cloud">
            
            <li><a href="https://datafibers-community.github.io/tags/big-data"><i class="fa fa-tags"></i> big-data</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/datafibers"><i class="fa fa-tags"></i> datafibers</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/flink"><i class="fa fa-tags"></i> flink</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/git"><i class="fa fa-tags"></i> git</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/hadoop"><i class="fa fa-tags"></i> hadoop</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/hbase"><i class="fa fa-tags"></i> hbase</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/hive"><i class="fa fa-tags"></i> hive</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/kafka"><i class="fa fa-tags"></i> kafka</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/machine-learning"><i class="fa fa-tags"></i> machine-learning</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/nosql"><i class="fa fa-tags"></i> nosql</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/redish"><i class="fa fa-tags"></i> redish</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/scala"><i class="fa fa-tags"></i> scala</a>
            </li>
            
            <li><a href="https://datafibers-community.github.io/tags/spark"><i class="fa fa-tags"></i> spark</a>
            </li>
            
        </ul>
    </div>
</div>






                        

                    </div>
                    

                    

                </div>
                

            </div>
            
        </div>
        

        <footer id="footer">
    <div class="container">

        
        <div class="col-md-4 col-sm-6">
            <h4>About us</h4>

            DataFibers are expertises by applying its cutting edge big data technologies and solutions on enterprise big data centric use cases.

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

        <div class="col-md-4 col-sm-6">

             
            <h4>Recent posts</h4>

            <div class="blog-entries">
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://datafibers-community.github.io/blog/2019/10/05/2019-10-05-flink-windows-explained/">
                          
                            <img src="https://datafibers-community.github.io//img/banners/flink_logo.jpg" class="img-responsive" alt="Flink Windows Explained">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://datafibers-community.github.io/blog/2019/10/05/2019-10-05-flink-windows-explained/">Flink Windows Explained</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://datafibers-community.github.io/blog/2019/09/15/2019-09-15-apache-airflow-overview/">
                          
                            <img src="https://datafibers-community.github.io//img/banners/air_flow.jpg" class="img-responsive" alt="Apache Airflow Overview">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://datafibers-community.github.io/blog/2019/09/15/2019-09-15-apache-airflow-overview/">Apache Airflow Overview</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://datafibers-community.github.io/blog/2019/09/02/2019-09-02-complete-sql-tuning/">
                          
                            <img src="https://datafibers-community.github.io//img/banners/sql_tuning.jpg" class="img-responsive" alt="The Complete SQL Tuning">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://datafibers-community.github.io/blog/2019/09/02/2019-09-02-complete-sql-tuning/">The Complete SQL Tuning</a></h5>
                    </div>
                </div>
                
            </div>

            <hr class="hidden-md hidden-lg">
             

        </div>
        

        
        <div class="col-md-4 col-sm-6">

          <h4>Contact</h4>

            <p><p><strong>DataFibers.</strong>
        <br>7030 Woodbine Avenue,
        <br>L3R 6G2
        <br>Ontario, Markham
        <br>Canadar
        <br>
        <br>
        <strong>Tel: +1 (647) 960-8578</strong>
        <br></p>


            <a href="/contact" class="btn btn-small btn-template-main">Go to contact page</a>

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

    </div>
    
</footer>







<div id="copyright">
    <div class="container">
        <div class="col-md-12">
            
            <p class="pull-left">Copyright (c) 2018, DataFibers all rights reserved.</p>
			<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
		    <span id="busuanzi_container_site_pv"> <span id="busuanzi_value_site_pv"></span> visits</span>
            
            <p class="pull-right">
              Template by <a href="http://bootstrapious.com/free-templates">Bootstrapious</a>.
              

              Powered by <a href="https://gohugo.io/">Hugo</a>
            </p>
        </div>
    </div>
</div>





    </div>
    

    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-40213017-3', 'auto');
ga('send', 'pageview');
</script>

<script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>

<script src="//maps.googleapis.com/maps/api/js?key=AIzaSyCksU3IZTuUK6fA-doQUfQ4KcYm7mB_vlk&v=3.exp"></script>

<script src="https://datafibers-community.github.io/js/hpneo.gmaps.js"></script>
<script src="https://datafibers-community.github.io/js/gmaps.init.js"></script>
<script src="https://datafibers-community.github.io/js/front.js"></script>


<script src="https://datafibers-community.github.io/js/owl.carousel.min.js"></script>


<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55ccd57a1c1b9515"></script>
  </body>
</html>
